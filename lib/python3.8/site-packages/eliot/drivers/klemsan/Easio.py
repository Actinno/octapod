
from eliot.logging.configured import log
from eliot.drivers.klemsan.specs.EasioSpecs import EasioSpecs

class Driver(EasioSpecs):
    """
    Implementación de driver para dispositivo Klemsan Easio
    """

    def on_off(self, on_state):
        """
        Método encargado de corta o habilitar el suministro de nergía.

        :param on_state: Boolean - True indica que el suministro debe estar habilitado
        """
        if on_state not in [ True, False, 0 , 1]:
            raise RuntimeError(f"on_state tiene que ser boolean. Valor inválido: {on_state}")

        log_prefix = f"Modbus Gateway: {self.mgw.addr}:{self.mgw.port} - Easio Addr: {self.addr} -> "

        # Obtengo modo de configuración de Easio
        di = self.digital_input.read_and_decode()
        log.info(f"digital_input: {di}")

        # XXX: Confirmar que esto sea lo correcto
        # Calculo los valores de ON/OFF a partir del modo de configuración de Digital Input
        ON  = di ^ 0
        OFF = ON ^ 1

        if on_state:
            cmd = ON
            cmd_txt = "Entregando"
        else:
            cmd = OFF
            cmd_txt = "Cortando"

        # Obtengo estado actual de Easio
        dro = self.digital_relay_output.read_and_decode()
        log.info(f"digital_relay_output: {dro}")

        # Sólo ejecuto la acción si el valor es diferente al del estado actual del Easio
        if dro != cmd:
            log.info(f"{log_prefix} {cmd_txt} energía")
            # XXX: Agregar control de errores
            self.digital_relay_output.write(cmd)

            # Valido si se aplicó el cambio o no
            log.info(f"{log_prefix} Validando configuración")
            dro = self.digital_relay_output.read_and_decode()
            log.info(f"digital_relay_output: {dro}")
            if dro == cmd:
                log.info(f"{log_prefix} Configuración aplicada")
            else:
                log.error(f"{log_prefix} No pude aplicar la configuración")
        else:
            log.info(f"{log_prefix} Ya tiene la configuración especificada")

